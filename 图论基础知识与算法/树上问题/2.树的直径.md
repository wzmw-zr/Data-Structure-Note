# 树的直径

图中所有最短路径的最大值即为直径，可以用两次DFS或者树形DP的方法在$O(n)$时间求出树的直径。

## 一、两次DFS

1. 首先对任意一个节点做DFS求出最远的节点，然后以这个节点为根节点再做DFS到达另一个最远节点。

   第一次DFS到达的节点可以证明一定是这个图的直径的一端，第二次DFS就会到达另一端。

2. **引理：**在一个连通无向无环图中，x，y，z是三个不同的节点。当x到y的最短路与y到z的最短路不重合时，x到z的最短路就是这两条最短路的拼接。

   > **证明：**
   >
   > 假设x到z有一条不经过y的更短路$\delta(x,z)$，则该路与$\delta(x,y),\delta(y,z)$形成一个环，与前提矛盾。

3. **定理：**在一个连通无向无环图中，以任意节点出发所能到达的最远节点，一定是该图直径的端点之一。

   **证明：**假设这条直径是$\delta(s,t)$。分两种情况：

   + **当出发节点$y$在$\delta(s,t)$时**，假设到达的最远节点$z$不是$s,t$中的任一个。这时将$\delta(y,z)$与不与之重合的$\delta(y,s)$拼接，可以得到一条更长的直径，与前提矛盾。
   + **当出发节点$y$不在$\delta(s,t)$上时**，分两种情况：
     + **当y到达的最远节点$z$横穿$\delta(s,t)$时，记与之相交的结点为x**。此时有$\delta(y,z)=\delta(y,x)+\delta(x,z)$。而此时$\delta(y,z)>\delta(y,t)$，故可得$\delta(x,z)>\delta(x,t)$，由1的结论可知该假设不成立。
     + **当y到达的最远节点z与$\delta(s,t)$不相交时**，记y到t的最短路首先与$\delta(s,t)$相交的节点是x。由假设$\delta(y,z)>\delta(y,x)+\delta(x,t)$。而$\delta(y,z)+\delta(y,x)+\delta(x,s)$又可以形成$\delta(z,s)$，而$\delta(z,s)>\delta(x,s)+\delta(x,t)+2\delta(y,x)=\delta(s,t)+2\delta(y,x)$，与题意矛盾。

   因此，定理成立。



## 二、树形DP

我们记录每个节点向下所能延伸的最远距离$d_1$和次远距离$d_2$，那么直径就是所有$d_1+d_2$的最大值。